# This file is to be merged on top of mgc/cli/openapis/dbaas.openapi.yaml
# using yaml_merge.py
# NOTE: Lists are merged by their indexes, be careful with parameters, tags and such!
# to keep it sane, keep some list item identifier (ex: "name") and add extra properties,
# such as "x-mgc-name" or "x-mgc-description"

paths:
    /v1/instances/{instance_id}/backups:
        post:
            responses:
                '202':
                    links:
                        get:
                            operationId: backup_detail_v1_instances__instance_id__backups__backup_id__get
                            description: Read a Backup
                            parameters:
                                id: $request.path.instance_id
                                backup_id: $response.body#/id
                        delete:
                            operationId: delete_backup_v1_instances__instance_id__backups__backup_id__delete
                            description: Delete a Backup
                            parameters:
                                id: $request.path.instance_id
                                backup_id: $response.body#/id
            security:
                -   OAuth2:
                    - dbaas.write
    /v1/instances/{instance_id}/backups/{backup_id}:
        get:
            responses:
                '200':
                    links:
                        delete:
                            operationId: delete_backup_v1_instances__instance_id__backups__backup_id__delete
                            description: Delete a Backup
                            parameters:
                                id: $response.body#/id
                                backup_id: $request.path.backup_id
            security:
            -   OAuth2:
                - dbaas.read
        delete:
            security:
            -   OAuth2:
                - dbaas.write
    /v1/datastores:
        get:
            security:
            -   OAuth2:
                - dbaas.read
    /v1/datastores/{datastore_id}:
        get:
            security:
            -   OAuth2:
                - dbaas.read
    /v1/flavors:
        get:
            security:
            -   OAuth2:
                - dbaas.read
    /v1/flavors/{flavor_id}:
        get:
            security:
            -   OAuth2:
                - dbaas.read
    /v1/instances:
        get:
            security:
            -   OAuth2:
                - dbaas.read
        post:
            responses:
              '202':
                  links:
                      get:
                          operationId: instances_v1_get_by_id
                          description: Read Database instance
                          parameters:
                              id: $response.body#/id
                      update:
                          operationId: instances_v1_patch
                          description: Update Database instance
                          parameters:
                              id: $response.body#/id
                      delete:
                          operationId: instances_v1_delete
                          description: Delete Database instance
                          parameters:
                              id: $response.body#/id
            security:
            -   OAuth2:
                - dbaas.write
    /v1/instances/{instance_id}:
        get:
            responses:
              '200':
                  links:
                      update:
                          operationId: instances_v1_patch
                          description: Update Database instance
                          parameters:
                              id: $response.body#/id
                      delete:
                          operationId: instances_v1_delete
                          description: Delete Database instance
                          parameters:
                              id: $response.body#/id
                      update/flavor_id:
                          operationId: instances_v1_resize
                          description: Resizes a database instance.
                          parameters:
                              id: $request.path.id
                          x-mgc-hidden: true
                      update/status/ACTIVE:
                          operationId: instances_v1_start
                          description: Starts a database instance.
                          parameters:
                              id: $request.path.id
                          x-mgc-hidden: true
                      update/status/STOPPED:
                          operationId: instances_v1_stop
                          description: Stops a database instance.
                          parameters:
                              id: $request.path.id
                          x-mgc-hidden: true
            security:
            -   OAuth2:
                - dbaas.read
            x-mgc-wait-termination:
                maxRetries: 100
                interval: 20s
                jsonPathQuery: (hasKey($.result, "status")) && ($.result.status == "ACTIVE" || $.result.status == "STOPPED" || $.result.status == "ERROR")
        delete:
            security:
            -   OAuth2:
                - dbaas.write
        patch:
            responses:
              '200':
                  links:
                      get:
                          operationId: instances_v1_get_by_id
                          description: Read Database instance
                          parameters:
                              id: $request.path.id
                          x-mgc-wait-termination:
                              maxRetries: 20
                              interval: 10s
                              jsonPathQuery: (hasKey($.owner.parameters, "status")
                                  && $.result["status"] == $.owner.parameters["status"])
                                  || (hasKey($.owner.parameters, "backup_retention_days")
                                  && $.result["backup_retention_days"] == $.owner.parameters["backup_retention_days"])
                                  || (hasKey($.owner.parameters, "backup_starts_at")
                                  && $.result["backup_start_at"] == $.owner.parameters["backup_start_at"])
                      delete:
                          operationId: instances_v1_delete
                          description: Delete Database instance
                          parameters:
                              id: $request.path.id
            security:
            -   OAuth2:
                - dbaas.write
    /v1/instances/{instance_id}/resize:
        post:
            responses:
              '200':
                  links:
                      get:
                          operationId: instances_v1_get_by_id
                          description: Read Database instance
                          parameters:
                              id: $request.path.id
                          x-mgc-wait-termination:
                              maxRetries: 20
                              interval: 10s
                              jsonPathQuery: $.result.flavor_id == $.owner.parameters.flavor_id
            security:
            -   OAuth2:
                - dbaas.write
    /v1/instances/{instance_id}/start:
        post:
            responses:
              '200':
                  links:
                      get:
                          operationId: instances_v1_get_by_id
                          description: Read Database instance
                          parameters:
                              id: $request.path.id
                          x-mgc-wait-termination:
                              maxRetries: 20
                              interval: 10s
                              jsonPathQuery: $.result.status == "ACTIVE"
            security:
            -   OAuth2:
                - dbaas.write
    /v1/instances/{instance_id}/stop:
        post:
            responses:
              '200':
                  links:
                      get:
                          operationId: instances_v1_get_by_id
                          description: Read Database instance
                          parameters:
                              id: $request.path.id
                          x-mgc-wait-termination:
                              maxRetries: 20
                              interval: 10s
                              jsonPathQuery: $.result.status == "STOPPED"
            security:
            -   OAuth2:
                - dbaas.write
    /v1/replicas:
        get:
            security:
            -   OAuth2:
                - dbaas.read
        post:
            responses:
              '202':
                  links:
                      get:
                          operationId: replica_detail_v1_replicas__replica_id__get
                          description: Read Database replica
                          parameters:
                              replica_id: $response.body#/id
                      delete:
                          operationId: replica_v1_delete
                          description: Delete Database replica
                          parameters:
                              replica_id: $response.body#/id
            security:
                -   OAuth2:
                    - dbaas.write
    /v1/replicas/{replica_id}:
        get:
            responses:
              '200':
                  links:
                      delete:
                          operationId: replica_v1_delete
                          description: Delete Database replica
                          parameters:
                              replica_id: $request.path.replica_id
                      update/flavor_id:
                          operationId: replica_resize_v1_replicas_post
                          description: Replica Resize.
                          parameters:
                              replica_id: $request.path.replica_id
                      update/status/ACTIVE:
                          operationId: replica_start_v1_replicas__replica_id__start_post
                          description: Start an instance replica.
                          parameters:
                              id: $request.path.id
                          x-mgc-hidden: true
                      update/status/STOPPED:
                          operationId: replica_stop_v1_replicas__replica_id__stop_post
                          description: Stop an instance replica.
                          parameters:
                              id: $request.path.id
                          x-mgc-hidden: true
            security:
            -   OAuth2:
                - dbaas.read
    /v1/replicas/{replica_id}/resize:
        post:
            security:
            -   OAuth2:
                - dbaas.write
    /v1/replicas/{replica_id}/start:
        post:
            security:
            -   OAuth2:
                - dbaas.write
    /v1/replicas/{replica_id}/stop:
        post:
            security:
            -   OAuth2:
                - dbaas.write

tags:
-   name: healthcheck
    x-mgc-hidden: true
-   name: backups
-   name: datastores
-   name: instances
-   name: flavors
-   name: replicas
-   name: restores
    x-mgc-hidden: true

components:
    schemas:
        InstanceCreateRequest:
            properties:
                name:
                    example: dbaas-name
                datastore_id:
                    example: 063f3994-b6c2-4c37-96c9-bab8d82d36f7
                flavor_id:
                    example: 8bbe8e01-40c8-4d2b-80e8-189debc44b1c
                user:
                    example: dbaas-user
                password:
                    example: dbaas-password
        InstanceVolumeRequest:
            properties:
                size:
                    example: 12
                type:
                    example: CLOUD_NVME_15K

servers:
-   url: https://{env}/{region}/database
    variables:
        region:
            description: Region to reach the service
            default: br-ne-1
            enum:
            - br-ne-1
            - br-se-1
        env:
            description: Environment to use
            default: api2.magalu.cloud
            enum:
            - api2.magalu.cloud
            - api.pre-prod.jaxyendy.com
            x-mgc-transforms:
            -   type: translate
                translations:
                -   from: prod
                    to: api2.magalu.cloud
                -   from: pre-prod
                    to: api.pre-prod.jaxyendy.com
