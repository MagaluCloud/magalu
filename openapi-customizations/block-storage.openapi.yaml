# This file is to be merged on top of mgc/cli/openapis/vpc.openapi.yaml
# using yaml_merge.py
# NOTE: Lists are merged by their indexes, be careful with parameters, tags and such!
# to keep it sane, keep some list item identifier (ex: "name") and add extra properties,
# such as "x-mgc-name" or "x-mgc-description"

servers:
-   url: https://{env}/{region}/volume
    variables:
        region:
            description: Region to reach the service
            default: br-ne-1
            enum:
            - br-ne-1
            - br-se-1
        env:
            description: Environment to use
            default: api2.magalu.cloud
            enum:
            - api2.magalu.cloud
            - api.pre-prod.jaxyendy.com
            x-mgc-transforms:
            -   type: translate
                translations:
                -   from: prod
                    to: api2.magalu.cloud
                -   from: pre-prod
                    to: api.pre-prod.jaxyendy.com

paths:
    /v0/volumes:
        get:
            x-mgc-description: List all Block Storage volumes
        post:
            x-mgc-description: Create a Block Storage volume
            responses:
                '201':
                    links:
                        read:
                            operationId: volume_details_v0_volumes__id__get
                            description: Read Block Storage volume
                            parameters:
                                id: $response.body#/id
                        update:
                            operationId: update_volume_v0_volumes__id__patch
                            description: Update Block Storage volume
                            parameters:
                                id: $response.body#/id
                        delete:
                            operationId: delete_volume_v0_volumes__id__delete
                            description: Delete Block Storage volume
                            parameters:
                                id: $response.body#/id
    /v0/volumes/{id}:
        get:
            x-mgc-description: Get a Block Storage volume details
            responses:
                '200':
                    links:
                        update:
                            operationId: update_volume_v0_volumes__id__patch
                            description: Update Block Storage volume
                            parameters:
                                id: $request.path.id
                        delete:
                            operationId: delete_volume_v0_volumes__id__delete
                            description: Delete Block Storage volume
                            parameters:
                                id: $request.path.id
                        create/attach-to-vm:
                            description: Attach this BS Volume to a VM instance
                            operationId: attach_volume_v0_volumes__id__attach__virtual_machine_id__post
                            parameters:
                                id: $request.path.id
                        delete/attach-to-vm:
                            description: Detach this BS Volume to a VM instance
                            operationId: detach_volume_v0_volumes__id__detach__virtual_machine_id__post
                            parameters:
                                id: $request.path.id
                        read/attach-to-vm:
                            description: Check if this BS Volume is attached to a VM instance
                            operationId: volume_details_v0_volumes__id__get
                            parameters:
                                id: $request.path.id
                            x-mgc-extra-parameters:
                                - name: virtual_machine_id
                                  required: true
                                  schema:
                                      type: string
                                      format: uuid
                            x-mgc-wait-termination:
                                maxRetries: 2
                                interval: 5s
                                jsonPathQuery: $.result.attachments[?(@.virtual_machine_id == $.parameters.virtual_machine_id)]
        delete:
            x-mgc-description: Delete a Block Storage volume
        patch:
            x-mgc-description: Update a Block Storage volume
            responses:
                '200':
                    links:
                        read:
                            operationId: volume_details_v0_volumes__id__get
                            description: Read Block Storage volume
                            parameters:
                                id: $request.path.id
                        delete:
                            operationId: delete_volume_v0_volumes__id__delete
                            description: Delete Block Storage volume
                            parameters:
                                id: $request.path.id
    /v0/volumes/{id}/attach/{virtual_machine_id}:
        post:
            x-mgc-name: attach
            responses:
                '200':
                    links:
                        delete:
                            description: Detach from a Virtual Machine instance
                            operationId: detach_volume_v0_volumes__id__detach__virtual_machine_id__post
                            parameters:
                                id: $request.path.id
                        read:
                            description: Check if block storage is attached to Virtual
                                Machine instance
                            operationId: volume_details_v0_volumes__id__get
                            parameters:
                                id: $request.path.id
                            x-mgc-wait-termination:
                                maxRetries: 1
                                interval: 5s
                                jsonPathQuery: $.result.attachments[?(@.virtual_machine_id == $.owner.parameters.virtual_machine_id)]
    /v0/volumes/{id}/detach/{virtual_machine_id}:
        post:
            x-mgc-name: detach
    /v0/snapshots:
        post:
            responses:
                '202':
                    links:
                        delete:
                            operationId: delete_snapshot_v0_snapshots__snapshot_id__delete
                            description: Delete snapshot
                            parameters:
                                snapshot_id: $response.body#/id
    /v0/snapshots/{snapshot_id}:
        post:
            parameters:
            -   name: snapshot_id
                x-mgc-name: id
            x-mgc-name: restore
        delete:
            parameters:
            -   name: snapshot_id
                x-mgc-name: id
    /v0/volume_types_all:
        get:
            x-mgc-hidden: true


tags:
-   name: healthchecks
    description: healthchecks
    x-mgc-hidden: true
-   name: usage
    description: usage
-   name: snapshots
    description: snapshots
-   name: volume-types
    description: volume types
-   name: block-storage
    x-mgc-description: Block Storage Volume Resources
    x-mgc-name: volume
