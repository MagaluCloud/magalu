# MGC SDK

This repository holds the SDKs developed for Magalu Cloud (MGC). Each subdirectory
inside [mgc/](./mgc) translates to a Go library:

* **[core](./mgc/core)**: Definition of data types used for the intermediate
structure generated by the SDK after parsing either an OpenAPI spec or a static
definition.

* **[sdk](./mgc/sdk/)**: Implement visitor pattern on the data types defined by core
to generate usable commands. The commands can be used by the CLI via Cobra commands, or
by Terraform Plugin Provider to perform CRUD on resources.

* **[CLI](./mgc/cli)**: Go CLI, using Cobra, with commands and actions defined by
the SDK. The commands can either come from dynamic loaded OpenAPI spec or static
modules, i.e: authentication.

Most of our code is written in Golang, however there are some utility scripts written
in Python as well.

## Dependencies

To run the project, the main dependency needed is [Go](https://go.dev/dl/). To
install, visit the official link with the instructions.

There are some utility scripts written in [Python](https://www.python.org/downloads/).
To install, visit the official website.


## Running the CLI

The quickest way to run in development is by going into the folder and running as:

```shell
cd mgc/cli
go run main.go
```

Or, build and run:

```shell
cd mgc/cli && go build -o cli && ./cli
```

### Authentication

To get a token, one can run

```shell
cd mgc/cli
go run main.go auth login
```

A browser will open, redirecting the user to id.magalu.com. After completing authentication,
the token will be saved to `$HOME/.mgc.yaml` and reused by the CLI in further actions:

To ensure it is working, perform a CLI command that requires authentication:

```shell
go run main.go virtual-machine instances list
```

NOTE: One can still use the env var to override the value of the token by setting:

```shell
export MGC_SDK_ACCESS_TOKEN=""
```


## Adding new APIs

To add a new API spec, run `./scripts/add_specs.sh` with the following:

```shell
./scripts/add_specs.sh mke https://mke.br-ne-1.jaxyendy.com/docs/openapi-with-snippets.json
./scripts/add_specs.sh dbaas https://dbaas.br-ne-1.jaxyendy.com/openapi.json
./scripts/add_specs.sh object-storage https://object-storage.br-ne-1.jaxyendy.com/openapi.json
```

This will fetch the URL, apply modifications and save in the given path `mgc/cli/openapis`.

## Contributing

### pre-commit

We use [pre-commit](https://pre-commit.com/) to install git hooks and enforce
lint, formatting, tests, commit messages and others. This tool depends on
Python as well. On pre-commit we enforce:

* On `commit-msg` for all commits:
    * [Conventional commit](https://www.conventionalcommits.org/en/v1.0.0/) pattern
    with [commitzen](https://github.com/commitizen/cz-cli)
* On `pre-commit` for Go files:
    * Complete set of [golangci-lint](https://golangci-lint.run/): `errcheck`,
    `gosimple`, `govet`, `ineffasign`, `staticcheck`, `unused`
* On `pre-commit` for Python files:
    * `flake8` and `black` enforcing pep code styles

#### Installation

#### Mac
```sh
brew install pre-commit
```

#### pip

```sh
pip install pre-commit
```

For other types of installation, check their
[official doc](https://pre-commit.com/#install).

#### Configuration

After installing, the developer must configure the git hooks inside its clone:

```sh
pre-commit install
```

### Linters

We install the go linters via `pre-commit`, so it is automatically run by the
pre-commit git hook. However, if one wants to run standalone it can be done via:

```sh
pre-commit run golangci-lint
```
